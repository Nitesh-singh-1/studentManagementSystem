@using EmployeeManagementSystem.Models
@model List<EmployeeResponse>

<style>
    /* === Responsive Table Wrapper === */
    .table-responsive-custom {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        border-radius: 8px;
    }

    #employeeTable {
        border-radius: 8px;
        min-width: 900px; /* ensures table doesn't shrink too much */
    } 

        #employeeTable thead {
            background: #f8f9fc;
            font-weight: 600;
            white-space: nowrap;
        }

        #employeeTable tbody tr:hover {
            background: #f1f4fa;
            transition: 0.2s ease;
        }

        #employeeTable td {
            vertical-align: middle;
            max-width: 200px;
            white-space: nowrap;
            /* overflow: hidden; */
            text-overflow: ellipsis;
        }

    /* === Buttons === */
    .btn-view {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeeba;
        transition: 0.3s;
    }

        .btn-view:hover {
            background-color: #ffe08a;
        }

    .btn-approve {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
        transition: 0.3s;
    }

        .btn-approve:hover {
            background-color: #b6dfbf;
        }

    .btn-reject {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
        transition: 0.3s;
    }

        .btn-reject:hover {
            background-color: #f1b0b7;
        }

    .btn-edit {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeeba;
    }

        .btn-edit:hover {
            background-color: #ffe08a;
        }

    .btn-delete {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

        .btn-delete:hover {
            background-color: #f1b0b7;
        }

    /* === Status badges === */
    .badge {
        font-size: 0.8rem;
        padding: 6px 10px;
        border-radius: 12px;
        white-space: nowrap;
    }

    /* === Pagination === */
    .pagination {
        border-radius: 50px;
        box-shadow: 0 0 5px rgba(0,0,0,0.08);
    }

        .pagination .page-item .page-link {
            border: none;
            color: #495057;
            padding: 8px 14px;
            border-radius: 30px;
            transition: 0.3s ease;
        }

            .pagination .page-item .page-link:hover {
                background-color: #007bff;
                color: white;
            }

        .pagination .page-item.active .page-link {
            background-color: #007bff;
            color: #fff;
        }

    .remark-cell {
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    /* === Small screen adjustments === */
    @@media (max-width: 768px) {
        #employeeTable td, #employeeTable th

    {
        font-size: 0.85rem;
        padding: 6px;
        max-width: 120px;
    }

    .btn, .btn-sm {
        font-size: 0.7rem;
        padding: 4px 8px;
    }

    .pagination .page-item .page-link {
        padding: 6px 10px;
        font-size: 0.8rem;
    }

    }
</style>

@{
    var apiBaseUrl = Configuration["ApiSettings:BaseUrl"];
    var userRole = Context.Session.GetString("UserRole") ?? "";
    var userId = Context.Session.GetInt32("UserId") ?? 0;
}

<div class="card shadow-sm border-0">
    <div class="card-body p-0 table-responsive-custom">
        <table id="employeeTable" class="table table-hover align-middle mb-0">
            <thead class="table-light text-uppercase">
                <tr>
                    <th>Col No</th>
                    <th>File No</th>
                    <th>Part No</th>
                    @* <th>Age</th> *@
                    @* <th>Gender</th> *@
                    <th>Subject</th>
                    <th>From Year</th>
                    <th>To Year</th>
                    <th>Status</th>
                    <th>Remark</th>
                    @* @if (userRole == "Admin")
                    {
                        <th class="text-center">Entry By</th>
                    } *@
                    <th class="text-center">Action</th>
                </tr>
            </thead>
            <tbody id="employeeTableBody"></tbody>
        </table>
    </div>

    <div class="d-flex justify-content-end align-items-center p-3">
        <nav>
            <ul class="pagination mb-0">
                <li class="page-item"><button class="page-link" id="prevPageBtn">Previous</button></li>
                <li class="page-item"><span class="page-link" id="pageInfo">Page 1</span></li>
                <li class="page-item"><button class="page-link" id="nextPageBtn">Next</button></li>
            </ul>
        </nav>
    </div>
</div>

<script>
    const apiBaseUrl = '@apiBaseUrl';
    const userRole = '@userRole';
    const currentUserId = @userId;
    window.allEmployees = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model ?? new List<EmployeeResponse>()));
    window.currentPage = 1;
    window.recordsPerPage = 10;

    window.renderPage = function (page) {
        const tableBody = document.getElementById("employeeTableBody");
        const pageInfo = document.getElementById("pageInfo");
        const prevBtn = document.getElementById("prevPageBtn");
        const nextBtn = document.getElementById("nextPageBtn");

        const total = (window.allEmployees || []).length;
        const maxPage = Math.max(1, Math.ceil(total / window.recordsPerPage));
        page = Math.min(Math.max(1, page), maxPage);
        window.currentPage = page;

        const start = (page - 1) * window.recordsPerPage;
        const end = start + window.recordsPerPage;
        const paged = (window.allEmployees || []).slice(start, end);

        tableBody.innerHTML = "";

        if (paged.length === 0) {
            tableBody.innerHTML = "<tr><td colspan='9' class='text-center text-muted py-4'>No employees found.</td></tr>";
            return;
        }

        paged.forEach(emp => {
            // const statusBadge = emp.isApproved === true
            //     ? `<span class="badge bg-success">Approved</span>`
            //     : emp.isApproved === false
            //         ? `<span class="badge bg-danger">Rejected</span>`
            //         : `<span class="badge bg-secondary">Pending</span>`;
            let statusBadge = '';

if (emp.IsDeleted) {
    statusBadge = `<span class="badge bg-danger">Delete Approved</span>`;
}
else if (emp.IsDeleteRequested) {
    statusBadge = `<span class="badge bg-warning">Delete Request Raised</span>`;
}
else if (emp.isApproved === true) {
    statusBadge = `<span class="badge bg-success">Approved</span>`;
}
else if (emp.isApproved === false) {
    statusBadge = `<span class="badge bg-danger">Rejected</span>`;
}
else {
    statusBadge = `<span class="badge bg-secondary">Pending</span>`;
}


                let actions = '';

    (emp.employeeDocuments || []).forEach(doc => {
        actions += `
            <a href="${apiBaseUrl}/Employee/ViewEmployeeDocument/${emp.Id}?docId=${doc.Id}"
               target="_blank"
               class="btn btn-sm btn-view me-1"
               style="background-color:#9cdcbe;color:green;">
               <i class="bi bi-eye"></i> View
            </a>
        `;
    });

            
            if (userRole === "Supervisor" || userRole ==="Admin") {
                actions += `
                    <button class="btn btn-sm btn-approve me-1" onclick="openRemarkModal(${emp.id || emp.Id}, true)">Approve</button>
                    <button class="btn btn-sm btn-reject" onclick="openRemarkModal(${emp.id || emp.Id}, false)">Reject</button>
                `;
            }

            if (userRole === "Operator") {
                const disabled = emp.isApproved === true ? "disabled" : "";
                actions += `
                    <a href="/Employee/Edit/${emp.id || emp.Id}" class="btn btn-sm btn-edit me-1 ${disabled}">
                        <i class="bi bi-pencil"></i> Edit
                    </a>
                   <button
    class="btn btn-sm btn-delete"
    onclick="raiseDeleteRequest(${emp.id || emp.Id})"
    ${emp.isDeleteRequested || emp.isDeleted ? 'disabled' : ''}>
    <i class="bi bi-trash"></i> Delete
</button>

                `;
                 // <form action="/Report/DelEmployee/${emp.id || emp.Id}" method="post" class="d-inline" onsubmit="return confirm('Delete this employee?');">
                 //        <button type="submit" class="btn btn-sm btn-delete ${disabled}" ${disabled}>
                 //            <i class="bi bi-trash"></i> Delete
                 //        </button>
                 //    </form>
            }

            const row = `
                <tr title="${emp.employeeName || ''}">
                    <td class="remark-cell" title="${emp.employeeName || ''}">${emp.employeeName || ''}</td>
                    <td class="remark-cell" title="${emp.department || ''}">${emp.department || ''}</td>
                    <td class="remark-cell" title="${emp.designation || ''}">${emp.designation || ''}</td>
                    
                    <td class="remark-cell" title="${emp.subject || ''}">${emp.subject || ''}</td>
                    <td class="remark-cell" title="${emp.address || ''}">${emp.address || ''}</td>
                    <td class="remark-cell" title="${emp.ToYear || ''}">${emp.ToYear || ''}</td>
                    <td>${statusBadge}</td>
                    <td class="remark-cell" title="${emp.remarks || emp.Remarks || ''}">${emp.remarks || emp.Remarks || ''}</td>
                    
                    <td class="text-center">${actions}</td>
                </tr>
            `;
            tableBody.insertAdjacentHTML('beforeend', row);
        });

        pageInfo.innerText = `Page ${page} / ${maxPage}`;
        prevBtn.disabled = page === 1;
        nextBtn.disabled = page === maxPage || total === 0;
    };

    document.addEventListener('DOMContentLoaded', () => window.renderPage(1));
    document.getElementById("prevPageBtn").addEventListener("click", () => window.renderPage(window.currentPage - 1));
    document.getElementById("nextPageBtn").addEventListener("click", () => window.renderPage(window.currentPage + 1));


    function raiseDeleteRequest(employeeId) {
    if (!confirm("Raise delete request for this employee?")) return;

    fetch(`${apiBaseUrl}/Employee/delete-requested/${employeeId}?userId=${currentUserId}`, {
        method: 'POST'
    })
    .then(res => res.json())
    .then(() => {
        alert("Delete request raised");
        location.reload();
    })
    .catch(() => alert("Error raising delete request"));
}

</script>
