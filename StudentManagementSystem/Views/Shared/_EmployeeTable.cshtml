@using EmployeeManagementSystem.Models
@model List<EmployeeResponse>
<style>
    /* === Dashboard Table Styling === */
    #employeeTable {
        border-radius: 8px;
        overflow: hidden;
    }

        #employeeTable thead {
            background: #f8f9fc;
            font-weight: 600;
        }

        #employeeTable tbody tr:hover {
            background: #f1f4fa;
            transition: 0.2s ease;
        }

    /* === Buttons === */
    .btn-view {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeeba;
        transition: 0.3s;
    }

        .btn-view:hover {
            background-color: #ffe08a;
        }

    .btn-approve {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
        transition: 0.3s;
    }

        .btn-approve:hover {
            background-color: #b6dfbf;
        }

    .btn-reject {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
        transition: 0.3s;
    }

        .btn-reject:hover {
            background-color: #f1b0b7;
        }

    /* === Status badges === */
    .badge {
        font-size: 0.8rem;
        padding: 6px 10px;
        border-radius: 12px;
    }

    /* === Pagination === */
    .pagination {
        border-radius: 50px;
        box-shadow: 0 0 5px rgba(0,0,0,0.08);
    }

        .pagination .page-item .page-link {
            border: none;
            color: #495057;
            padding: 8px 14px;
            border-radius: 30px;
            transition: 0.3s ease;
        }

            .pagination .page-item .page-link:hover {
                background-color: #007bff;
                color: white;
            }

        .pagination .page-item.active .page-link {
            background-color: #007bff;
            color: #fff;
        }

    /* === Footer === */
    .footer {
        text-align: center;
        color: #6c757d;
        font-size: 0.9rem;
        margin-top: 2rem;
        padding: 1rem 0;
        border-top: 1px solid #e9ecef;
        background-color: #f8f9fc;
    }
</style>
@{
    var apiBaseUrl = Configuration["ApiSettings:BaseUrl"];
}
<div class="card shadow-sm border-0">
    <div class="card-body p-0">
        <table id="employeeTable" class="table table-hover align-middle mb-0">
            <thead class="table-light text-uppercase">
                <tr>
                    <th>Name</th>
                    <th>Department</th>
                    <th>Designation</th>
                    <th>Age</th>
                    <th>Gender</th>
                    <th>Address</th>
                    <th class="text-center">View</th>
                    @if (@Context.Session.GetString("UserRole") == "Supervisor") {
                        <th class="text-center">Action</th>
                    }
                    
                    <th>Status</th>
                    <th>Remark</th>
                </tr>
            </thead>
            <tbody id="employeeTableBody">
                <!-- initial server render will be replaced by JS -->
            </tbody>
        </table>

        <div class="d-flex justify-content-end align-items-center p-3">
            <nav>
                <ul class="pagination mb-0">
                    <li class="page-item"><button class="page-link" id="prevPageBtn">Previous</button></li>
                    <li class="page-item"><span class="page-link" id="pageInfo">Page 1</span></li>
                    <li class="page-item"><button class="page-link" id="nextPageBtn">Next</button></li>
                </ul>
            </nav>
        </div>
    </div>
</div>

<!-- Inline script attaches everything to window so other scripts can use it -->
<script>
    const apiBaseUrl = '@apiBaseUrl';
    
    window.allEmployees = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model ?? new List<EmployeeResponse>()));
    window.currentPage = window.currentPage || 1;
    window.recordsPerPage = 10;

    // render function exposed globally
    window.renderPage = function(page) {
      const tableBody = document.getElementById("employeeTableBody");
      const pageInfo = document.getElementById("pageInfo");
      const prevBtn = document.getElementById("prevPageBtn");
      const nextBtn = document.getElementById("nextPageBtn");

      if (!tableBody || !pageInfo || !prevBtn || !nextBtn) return;

      // clamp page
      const total = (window.allEmployees || []).length;
      const maxPage = Math.max(1, Math.ceil(total / window.recordsPerPage));
      page = Math.min(Math.max(1, page), maxPage);
      window.currentPage = page;

      const start = (page - 1) * window.recordsPerPage;
      const end = start + window.recordsPerPage;
      const paged = (window.allEmployees || []).slice(start, end);

      tableBody.innerHTML = "";

      if (paged.length === 0) {
        tableBody.innerHTML = "<tr><td colspan='10' class='text-center text-muted py-4'>No employees found.</td></tr>";
      } else {
        paged.forEach(emp => {
          const statusBadge = emp.isApproved === true
            ? `<span class="badge bg-success">Approved</span>`
            : emp.isApproved === false
              ? `<span class="badge bg-danger">Rejected</span>`
              : `<span class="badge bg-secondary">Pending</span>`;

          const row = `
            <tr>
              <td>${emp.employeeName || ''}</td>
              <td>${emp.department || ''}</td>
              <td>${emp.designation || ''}</td>
              <td>${emp.age ?? ''}</td>
              <td>${emp.gender || ''}</td>
              <td>${emp.address || ''}</td>
              <td class="text-center">
                <a href="${encodeURI((apiBaseUrl || '') + '/Employee/ViewEmployeeDocument/' + (emp.id || emp.Id || ''))}"
                   target="_blank"
                   class="btn btn-sm btn-view">
                   <i class="bi bi-eye"></i> View
                </a>
              </td>
               @if (Context.Session.GetString("UserRole") == "Supervisor")
    {
            <text>
            <td style="justify-content:space-evenly;display:flex;">
              <button class="btn btn-sm btn-approve" onclick="openRemarkModal(${emp.id || emp.Id}, true)">Approve</button>
              <button class="btn btn-sm btn-reject" onclick="openRemarkModal(${emp.id || emp.Id}, false)">Reject</button>
            </td>
            </text>
    }
    
              <td>${statusBadge}</td>
              <td>${emp.remarks || emp.Remarks || ''}</td>
            </tr>
          `;
          tableBody.insertAdjacentHTML('beforeend', row);
        });
      }

      pageInfo.innerText = `Page ${page} / ${maxPage}`;
      prevBtn.disabled = page === 1;
      nextBtn.disabled = page === maxPage || total === 0;
    };

    // hook up buttons (guard in case script runs before DOM ready)
    (function attachPaginationButtons(){
      function tryAttach() {
        const prevBtn = document.getElementById("prevPageBtn");
        const nextBtn = document.getElementById("nextPageBtn");
        if (!prevBtn || !nextBtn) {
          // try again shortly
          setTimeout(tryAttach, 50);
          return;
        }
        prevBtn.addEventListener("click", () => {
          if (window.currentPage > 1) window.renderPage(window.currentPage - 1);
        });
        nextBtn.addEventListener("click", () => {
          window.renderPage(window.currentPage + 1);
        });
      }
      tryAttach();
    })();

    // initial render
    document.addEventListener('DOMContentLoaded', function() {
      window.renderPage(window.currentPage || 1);
    });
</script>
