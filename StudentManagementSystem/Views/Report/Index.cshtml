@using EmployeeManagementSystem.Models
@model List<EmployeeResponse>

@{
    ViewBag.Title = "Employee Report";
}
@inject IConfiguration Configuration
@{
    var apiBaseUrl = Configuration["ApiSettings:BaseUrl"];
}
<div class="container my-5">
@* <div class="input-group mb-3">
    <input id="searchInput" type="text" class="form-control" placeholder="Search by keyword...">
    <button class="btn btn-primary" type="button" onclick="searchResumes()">Search</button>
    <button class="btn btn-secondary" type="button" onclick="window.location.reload()">Clear</button>
</div> *@
<div class="report-container py-4 px-3">
    @* <h2 class="fw-bold text-center mb-4 text-primary">Employee Report</h2> *@

    <table id="employeeTable" class="table table-hover align-middle w-100 m-0">
        <thead class="table-header text-uppercase">
            <tr>
                <th>Name</th>
                <th>Department</th>
                <th>Designation</th>
                <th>Age</th>
                <th>Gender</th>
                <th>Address</th>
                <th>Status</th>
                <th>Remark</th>
                <th class="text-center">Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var emp in Model)
            {
                var isActionDisabled = emp.isApproved==true; 
                var statusBadge = emp.isApproved == true
                    ? "<span class='badge bg-success'>Approved</span>"
                    : emp.isApproved == false
                        ? "<span class='badge bg-danger'>Rejected</span>"
                        : "<span class='badge bg-secondary'>Pending</span>";

                <tr>
                    <td>@emp.employeeName</td>
                    <td>@emp.department</td>
                    <td>@emp.designation</td>
                    <td>@emp.age</td>
                    <td>@emp.gender</td>
                    <td>@emp.address</td>
                    <td>@Html.Raw(statusBadge)</td>
                        <td class="remark-cell">@emp.Remarks</td>
                    <td class="text-center">
                        <a asp-action="View" asp-controller="Employee" asp-route-id="@emp.Id"
                           class="btn btn-sm btn-info px-3 me-1"
                           title="View Employee Details">View</a>

                        <a asp-action="Edit" asp-controller="Employee" asp-route-id="@emp.Id"
                           class="btn btn-sm btn-warning px-3 me-1 @(isActionDisabled ? "disabled-btn" : "")"
                           title="Edit Employee" @@(isActionDisabled ? "tabindex='-1' aria-disabled='true'" : "")>
                            Edit
                        </a>

                        <form asp-action="DelEmployee" asp-controller="Report" asp-route-id="@emp.Id"
                              method="post" class="d-inline"
                              onsubmit="return confirm('Are you sure you want to delete this employee?');">
                            <button type="submit"
                                    class="btn btn-sm btn-danger px-3 @(isActionDisabled ? "disabled-btn" : "")"
                                    title="Delete Employee" @(isActionDisabled ? "disabled" : "")>
                                Delete
                            </button>
                        </form>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>
</div>
@section Scripts {
    <script>
        const apiBaseUrl = '@apiBaseUrl';

                async function searchResumes() {
            const keyword = document.getElementById("searchInput").value.trim();
            if (!keyword) {
                alert("Please enter a keyword");
                return;
            }

            const tableBody = document.querySelector("#employeeTable tbody");
            tableBody.innerHTML = "<tr><td colspan='10' class='text-center'>Searching...</td></tr>";

            try {
                const response = await fetch(`${apiBaseUrl}/Employee/SearchResumes?keyword=${encodeURIComponent(keyword)}`);
                if (!response.ok) {
                    tableBody.innerHTML = "<tr><td colspan='10' class='text-center text-danger'>No resumes found</td></tr>";
                    return;
                }

                const resumes = await response.json();
                const pdfNames = resumes.map(r => r.resumeName);

                // Now get all employees
                const empResponse = await fetch(`${apiBaseUrl}/Employee/getAll`);
                const employees = await empResponse.json();

                // Filter employees who have any document name in pdfNames
                const filtered = employees.filter(e =>
                    e.employeeDocuments?.some(d => pdfNames.includes(d.documentName))
                );
                        // allEmployees = filtered;
                        // currentPage = 1;
                        // renderPage(currentPage);
                if (filtered.length === 0) {
                    tableBody.innerHTML = "<tr><td colspan='10' class='text-center text-warning'>No matching employees found.</td></tr>";
                    return;
                }

                tableBody.innerHTML = "";

                filtered.forEach(emp => {
                    const statusBadge = emp.isApproved === true
                        ? `<span class="badge bg-success">Approved</span>`
                        : emp.isApproved === false
                            ? `<span class="badge bg-danger">Rejected</span>`
                            : `<span class="badge bg-secondary">Pending</span>`;
                                 const manageActions = `
        <td class="text-center">
            <a href="/Employee/View/${emp.id}" class="btn btn-sm btn-info px-3 me-1" title="View">View</a>
            <a href="/Employee/Edit/${emp.id}" class="btn btn-sm btn-warning px-3 me-1" title="Edit">Edit</a>
            <form method="post" action="/Report/DelEmployee/${emp.id}" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this employee?');">
                <button type="submit" class="btn btn-sm btn-danger px-3" title="Delete">Delete</button>
            </form>
        </td>`;
                    const row = `
                        <tr>
                            <td>${emp.employeeName}</td>
                            <td>${emp.department}</td>
                            <td>${emp.designation}</td>
                            <td>${emp.age}</td>
                            <td>${emp.gender}</td>
                            <td>${emp.address}</td>
                            <td>${statusBadge}</td>
                             <td class="remark-cell">${emp.remarks || ''}</td>
                            ${manageActions}

                                @if (Context.Session.GetString("UserRole") == "Supervisor")
        {
                    <text>
                    <td style="justify-content:space-evenly;display:flex;">
                      <button class="btn btn-sm btn-approve" onclick="openRemarkModal(${emp.id || emp.Id}, true)">Approve</button>
                      <button class="btn btn-sm btn-reject" onclick="openRemarkModal(${emp.id || emp.Id}, false)">Reject</button>
                    </td>
                    </text>
        }
                            
                           
                        </tr>
                    `;

                    tableBody.insertAdjacentHTML('beforeend', row);
                });
            } catch (err) {
                console.error(err);
                tableBody.innerHTML = "<tr><td colspan='10' class='text-center text-danger'>Error occurred while searching.</td></tr>";
            }
        }

    </script>
}

<style>
    .report-container {
        width: 100%;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(6px);
        border-radius: 8px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
    }

    h2 {
        font-weight: 700;
    }

    /* Table */
    table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.95rem;
    }

    thead.table-header {
        background-color: rgba(108, 92, 231, 0.1);
        color: #333;
        border-bottom: 2px solid #6c5ce7;
    }

    thead th {
        padding: 0.75rem;
        font-weight: 600;
        border-bottom: 2px solid #6c5ce7;
    }

    tbody td {
        padding: 0.75rem;
        vertical-align: middle;
    }

    tbody tr:hover {
        background-color: rgba(108, 92, 231, 0.06);
        transition: 0.2s ease-in-out;
    }

    /* Buttons */
    .btn {
        border-radius: 6px;
        font-weight: 500;
        transition: 0.2s ease;
    }

    .btn-info {
        background-color: #6c5ce7;
        border: none;
        color: white;
    }

    .btn-info:hover {
        background-color: #5a4bd8;
        color: white;
    }

    .btn-warning {
        background-color: #f1c40f;
        border: none;
        color: #333;
    }

    .btn-warning:hover {
        background-color: #d4ac0d;
        color: white;
    }

    .btn-danger {
        background-color: #e74c3c;
        border: none;
    }

    .btn-danger:hover {
        background-color: #c0392b;
    }

    /* Disabled state styling */
    .disabled-btn {
        opacity: 0.6;
        pointer-events: none;
        cursor: not-allowed;
    }

    /* Status badges */
    .badge {
        font-size: 0.8rem;
        padding: 6px 10px;
        border-radius: 12px;
    }

    .remark-cell {
        max-width: 175px; /* adjust width */
        white-space: nowrap; /* keep in one line */
        overflow: hidden; /* hide overflow */
        text-overflow: ellipsis; /* show ... */
    }
</style>
